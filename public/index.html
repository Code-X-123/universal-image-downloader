<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Queue Downloader</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --bg-color: #121212; --sidebar-bg: #1e1e1e; --text-color: #e0e0e0; --bg-secondary: #2c2c2c; --accent: #007bff; --log-bg: #000000; --border: #333; }
        [data-theme="light"] { --bg-color: #f5f7fa; --sidebar-bg: #ffffff; --text-color: #333; --bg-secondary: #e4e6eb; --accent: #007bff; --log-bg: #f0f2f5; --border: #ddd; }
        
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex; height: 100vh; margin: 0; overflow: hidden; transition: 0.3s; }
        
        /* SIDEBAR */
        .sidebar { width: 300px; background: var(--sidebar-bg); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .sidebar-header { padding: 15px; font-weight: bold; background: var(--bg-secondary); border-bottom: 1px solid var(--border); font-size: 14px; letter-spacing: 0.5px; text-transform: uppercase; }
        .history-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* History Item */
        .history-item { background: var(--bg-secondary); padding: 10px; margin-bottom: 6px; border-radius: 6px; font-size: 13px; cursor: pointer; border-left: 3px solid transparent; display: flex; justify-content: space-between; align-items: flex-start; transition: 0.2s; }
        .history-item:hover { background: var(--bg-color); border-left: 3px solid var(--accent); }
        .history-item.pinned { border-left: 3px solid #ffc107; background: rgba(255, 193, 7, 0.1); }
        .history-text { flex: 1; padding-right: 10px; word-break: break-word; overflow-wrap: anywhere; line-height: 1.4; }
        .actions { display: flex; gap: 5px; min-width: 40px; justify-content: flex-end; opacity: 0.6; }
        .history-item:hover .actions { opacity: 1; }
        .icon-btn { cursor: pointer; padding: 2px; } .icon-btn:hover { transform: scale(1.2); }

        /* MAIN AREA */
        .main { flex: 1; padding: 30px; display: flex; flex-direction: column; max-width: 900px; margin: 0 auto; width: 100%; }
        
        /* HEADER ROW (Title + Top Right Buttons) */
        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h1 { margin: 0; font-size: 24px; font-weight: 700; background: linear-gradient(45deg, var(--accent), #00d2ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .top-controls { display: flex; gap: 10px; }
        .circle-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--bg-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; color: var(--text-color); }
        .circle-btn:hover { background: var(--accent); color: white; transform: rotate(15deg); }
        .circle-btn svg { width: 20px; height: 20px; fill: currentColor; }
        .folder-btn-top { background: #ffc107; color: #1a1a1a; } /* Yellow for folder */
        .folder-btn-top:hover { background: #e0a800; color: black; transform: scale(1.1); }

        /* INPUT ROW */
        .input-container { display: flex; gap: 10px; margin-bottom: 15px; position: relative; }
        input[type="text"] { flex: 1; padding: 15px; border-radius: 10px; border: 2px solid var(--bg-secondary); background: var(--bg-secondary); color: var(--text-color); outline: none; font-size: 16px; transition: 0.3s; }
        input[type="text"]:focus { border-color: var(--accent); background: var(--bg-color); }
        .btn-add { padding: 0 30px; background: var(--accent); color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn-add:hover { filter: brightness(1.1); }

        /* OPTIONS ROW (Toggles + Queue Badge) */
        .options-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 5px; }
        .toggles-group { display: flex; gap: 20px; }
        
        /* Compact Toggles */
        .toggle-item { display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: 500; opacity: 0.8; }
        .toggle-switch { position: relative; width: 36px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--bg-secondary); border-radius: 34px; transition: .4s; border: 1px solid var(--border); }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: #888; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: var(--accent); border-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); background-color: white; }
        
        .queue-badge { font-size: 12px; background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-weight: bold; display: none; }

        /* STATUS DASHBOARD */
        .dashboard { background: var(--sidebar-bg); border-radius: 15px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; flex: 1; min-height: 0; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .dashboard-header { padding: 15px 20px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .status-title { font-weight: bold; font-size: 15px; display: flex; align-items: center; gap: 10px; }
        .status-dot { width: 10px; height: 10px; background: #555; border-radius: 50%; display: inline-block; }
        .status-dot.active { background: #28a745; box-shadow: 0 0 10px #28a745; animation: pulse 1.5s infinite; }
        
        .dashboard-controls { display: flex; gap: 10px; }
        .mini-btn { padding: 6px 15px; border-radius: 6px; border: none; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; display: none; }
        .btn-skip { background: #ffc107; color: black; }
        .btn-stop { background: #dc3545; color: white; }
        .mini-btn:hover { transform: translateY(-1px); filter: brightness(1.1); }

        .dashboard-body { padding: 20px; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .stats-text { font-size: 20px; font-weight: bold; color: var(--accent); margin-bottom: 15px; }
        
        .logs-container { flex: 1; background: var(--log-bg); border-radius: 8px; padding: 15px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 12px; color: #888; border: 1px solid var(--border); }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .log-entry:last-child { border: none; }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">Recent Activity</div>
        <div class="history-list" id="historyList"></div>
    </div>

    <div class="main">
        
        <div class="header-row">
            <h1>Queue Downloader</h1>
            <div class="top-controls">
                <button class="circle-btn folder-btn-top" onclick="openFolder()" title="Open Downloads Folder">
                    <svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/></svg>
                </button>
                <button class="circle-btn" onclick="toggleTheme()" id="themeBtn" title="Toggle Theme">
                    <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
                </button>
            </div>
        </div>

        <div class="input-container">
            <input type="text" id="urlInput" placeholder="Paste link OR Keyword (e.g. 'Neon City', 'Apple Logo')" autofocus>
            <button class="btn-add" onclick="addToQueue()">+ Add Task</button>
        </div>

        <div class="options-row">
            <div class="toggles-group">
                <label class="toggle-item">
                    <div class="toggle-switch"><input type="checkbox" id="loopToggle"><span class="slider"></span></div>
                    <span>Infinite Loop</span>
                </label>
                <label class="toggle-item">
                    <div class="toggle-switch"><input type="checkbox" id="headlessToggle"><span class="slider"></span></div>
                    <span>Debug View</span>
                </label>
            </div>
            <div id="queueBadge" class="queue-badge">0 Pending</div>
        </div>

        <div class="dashboard">
            <div class="dashboard-header">
                <div class="status-title">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusTitle">Ready</span>
                </div>
                <div class="dashboard-controls">
                    <button class="mini-btn btn-skip" id="skipBtn" onclick="skipTask()">‚è≠ Skip</button>
                    <button class="mini-btn btn-stop" id="stopAllBtn" onclick="clearQueue()">üõë Stop All</button>
                </div>
            </div>
            
            <div class="dashboard-body">
                <div class="stats-text" id="statsText">Waiting for tasks...</div>
                <div class="logs-container" id="logs"></div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let lastFolder = '';

        const urlInput = document.getElementById('urlInput');
        const loopToggle = document.getElementById('loopToggle');
        const headlessToggle = document.getElementById('headlessToggle');
        
        const skipBtn = document.getElementById('skipBtn');
        const stopAllBtn = document.getElementById('stopAllBtn');
        const queueBadge = document.getElementById('queueBadge');
        
        const statusTitle = document.getElementById('statusTitle');
        const statusDot = document.getElementById('statusDot');
        const logsDiv = document.getElementById('logs');
        const themeBtn = document.getElementById('themeBtn');

        // Theme Icons
        const sunIcon='<svg viewBox="0 0 24 24"><path d="M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zm-3.21 13.7l1.79 1.79 1.41-1.41-1.79-1.79-1.41 1.41zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95zm-7.45-3.91l1.41 1.41 1.79-1.79-1.41-1.41-1.79 1.79z"/></svg>';
        const moonIcon='<svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>';
        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.getAttribute('data-theme') === 'dark';
            html.setAttribute('data-theme', isDark ? 'light' : 'dark');
            themeBtn.innerHTML = isDark ? sunIcon : moonIcon;
            localStorage.setItem('theme', isDark ? 'light' : 'dark');
        }
        if (localStorage.getItem('theme') === 'light') toggleTheme();

        urlInput.addEventListener("keypress", (e) => { if (e.key === "Enter") addToQueue(); });

        function addToQueue(urlOverride = null) {
            const url = urlOverride || urlInput.value;
            const loopMode = loopToggle.checked;
            const showBrowser = headlessToggle.checked;

            if(!url) return;
            
            // Activate UI state
            statusDot.classList.add('active');
            statusTitle.innerText = "Processing Queue...";
            skipBtn.style.display = 'inline-block';
            stopAllBtn.style.display = 'inline-block';
            
            logsDiv.scrollTop = logsDiv.scrollHeight;
            socket.emit('start-download', { url, loopMode, showBrowser });
            urlInput.value = ''; 
            urlInput.focus();
        }

        function skipTask() { socket.emit('stop-download'); }
        function clearQueue() { socket.emit('clear-queue'); }
        function openFolder() { socket.emit('open-folder', lastFolder); }
        function deleteHistory(url, e) { e.stopPropagation(); if(confirm('Remove?')) socket.emit('remove-history', url); }
        function togglePin(url, e) { e.stopPropagation(); socket.emit('toggle-pin', url); }

        socket.on('log', (msg) => {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerText = `> ${msg}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        });

        socket.on('progress', (data) => {
            document.getElementById('statsText').innerText = `Saved: ${data.saved}  |  Skipped: ${data.skipped}  |  Found: ${data.total}`;
        });

        socket.on('queue-update', (count) => {
            if (count > 0) {
                queueBadge.style.display = 'block';
                queueBadge.innerText = `${count} Pending`;
            } else {
                queueBadge.style.display = 'none';
            }
        });

        socket.on('queue-empty', () => {
            skipBtn.style.display = 'none'; 
            stopAllBtn.style.display = 'none';
            statusDot.classList.remove('active');
            statusTitle.innerText = "All Tasks Completed";
            document.getElementById('statsText').innerText = "Queue Finished.";
        });

        socket.on('done', (data) => { lastFolder = data.folderPath; });

        socket.on('update-history', (history) => {
            const list = document.getElementById('historyList');
            list.innerHTML = '';
            history.sort((a, b) => (b.pinned === a.pinned) ? 0 : b.pinned ? 1 : -1);
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = `history-item ${item.pinned ? 'pinned' : ''}`;
                div.onclick = () => addToQueue(item.url);
                div.innerHTML = `
                    <div class="history-text">${item.url}</div>
                    <div class="actions">
                        <span class="icon-btn" onclick="togglePin('${item.url}', event)">${item.pinned ? '‚≠ê' : '‚òÜ'}</span>
                        <span class="icon-btn" onclick="deleteHistory('${item.url}', event)">üóëÔ∏è</span>
                    </div>`;
                list.appendChild(div);
            });
        });
    </script>
</body>
</html>